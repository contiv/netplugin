#!/bin/bash

# generates the version of file based on current git version

cd $GOPATH/src/github.com/contiv/netplugin/version

USE_RELEASE=$1

BuildTimeStr=$(date -u +%m-%d-%Y.%H-%M-%S.UTC)
file_name=version_gen.go

if [ -z "$USE_RELEASE" ]
then
  useDefaultVersionString="False"
  VersionStr="$(cat ./CURRENT_VERSION)-$BuildTimeStr"
else
  useDefaultVersionString="True"
  VersionStr="$(cat ./CURRENT_VERSION)"
fi

if command -v git &> /dev/null && git rev-parse &> /dev/null; then
  GitCommitStr=$(git rev-parse --short HEAD)
  if [ -n "$(git status --porcelain --untracked-files=no)" ]; then
    GitCommitStr="$GitCommitStr-unsupported"
  fi
else
  echo >&2 'error: unable to determine the git revision'
  exit 1
fi

cat > $file_name << EOF
// NOTE: this file is auto-generated by PR commits

package version

const usedDefaultVersion = "$useDefaultVersionString"

// sample values are specified here
const (
	gitCommit  string = "$GitCommitStr"
	versionStr string = "$VersionStr"
	buildTime  string = "$BuildTimeStr"
)
EOF

exit 0
